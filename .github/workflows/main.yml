name: CI Quality Gate

# è§¸ç™¼æ¢ä»¶ï¼šç•¶ Push åˆ° main åˆ†æ”¯ï¼Œæˆ–ç™¼èµ· Pull Request æ™‚
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # --- Job 1: éœæ…‹ç¨‹å¼ç¢¼åˆ†æ (Cppcheck) ---
  static-analysis:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Cppcheck
        run: sudo apt-get update && sudo apt-get install -y cppcheck

      - name: Run MISRA C Compliance Check
        # æª¢æŸ¥ src è³‡æ–™å¤¾ï¼Œå•Ÿç”¨æ‰€æœ‰è­¦å‘Š
        run: |
          cppcheck --enable=all --error-exitcode=1 \
          --suppress=missingInclude \
          --suppress=missingIncludeSystem \
          --suppress=unusedFunction \
          --suppress=unmatchedSuppression \
          -I src/common -I src/hal -I src/app \
          src/

  # --- Job 2: å–®å…ƒæ¸¬è©¦ (Unit Test) ---
  unit-test:
    runs-on: ubuntu-latest
    needs: static-analysis
    steps:
      - uses: actions/checkout@v4

      - name: Install CMake & GCC
        run: sudo apt-get update && sudo apt-get install -y cmake build-essential

      - name: Configure CMake (Test)
        # é€™è£¡æœƒè‡ªå‹•è®€å– test/CMakeLists.txt
        # ä¸¦æŠ“åˆ°æˆ‘å€‘è¨­å®šå¥½çš„ Mock è·¯å¾‘
        run: cmake -S test -B build_test

      - name: Build Tests
        run: cmake --build build_test

      - name: Run Tests (CTest)
        # ğŸ’¡ é—œéµä¿®æ­£ï¼šä½¿ç”¨ ctest è‡ªå‹•åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦ (Blink + GPIO)
        # --output-on-failure: åªæœ‰å¤±æ•—æ™‚æ‰å°å‡ºè©³ç´°éŒ¯èª¤ï¼Œä¿æŒç‰ˆé¢ä¹¾æ·¨
        run: |
          cd build_test
          ctest --output-on-failure

  # --- Job 3: éŸŒé«”ç·¨è­¯ (Firmware Build) ---
  firmware-build:
    runs-on: ubuntu-latest
    needs: unit-test # æ¸¬è©¦éƒ½éäº†ï¼Œæ‰çœŸçš„å»ç·¨è­¯éŸŒé«”
    steps:
      - uses: actions/checkout@v4
      
      # å®‰è£ ARM Cross Compiler
      - name: Install Toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential gcc-arm-none-eabi libnewlib-arm-none-eabi libstdc++-arm-none-eabi-newlib

      # ä¸‹è¼‰ Pico SDK
      - name: Setup Pico SDK
        run: |
          git clone https://github.com/raspberrypi/pico-sdk.git
          cd pico-sdk
          git submodule update --init
          echo "PICO_SDK_PATH=$PWD" >> $GITHUB_ENV

      # è¨­å®š CMake (æŒ‡å®šæ¿å­ç‚º pico2_w)
      - name: Configure CMake (Firmware)
        # é€™è£¡çš„ -S . ä»£è¡¨ source åœ¨æ ¹ç›®éŒ„
        run: cmake -S . -B build -DPICO_BOARD=pico2_w

      # é–‹å§‹ç·¨è­¯ (ä½¿ç”¨ 4 æ ¸å¿ƒåŠ é€Ÿ)
      - name: Build Firmware
        run: cmake --build build -j4