name: CI Quality Gate

# 觸發條件：當 Push 到 main 分支，或發起 Pull Request 時
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # --- Job 1: 靜態程式碼分析 (Cppcheck) ---
  static-analysis:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Cppcheck
        run: sudo apt-get update && sudo apt-get install -y cppcheck

      - name: Run MISRA C Compliance Check
        # 檢查 src 資料夾，啟用所有警告，並強制檢查缺失的 include
        # 如果有錯誤，回傳 exit code 1 (讓 CI 失敗)
        run: |
          cppcheck --enable=all --error-exitcode=1 \
          --suppress=missingInclude \
          --suppress=missingIncludeSystem \
          --suppress=unusedFunction \
          --suppress=unmatchedSuppression \
          -I src/common -I src/hal -I src/app \
          src/

  # --- Job 2: 單元測試 (Unit Test) ---
  unit-test:
    runs-on: ubuntu-latest
    needs: static-analysis # 只有當靜態分析通過後，才跑測試
    steps:
      - uses: actions/checkout@v4

      - name: Install CMake & GCC
        run: sudo apt-get update && sudo apt-get install -y cmake build-essential

      - name: Configure CMake (Test)
        # 這裡的 -S test 代表 source 在 test 資料夾
        run: cmake -S test -B build_test

      - name: Build Tests
        run: cmake --build build_test

      - name: Run Tests
        # 執行編譯出來的測試檔
        run: ./build_test/test_blink

  # --- Job 3: 韌體編譯 (Firmware Build) ---
  firmware-build:
    runs-on: ubuntu-latest
    needs: unit-test # 測試都過了，才真的去編譯韌體給 Pico 用
    steps:
      - uses: actions/checkout@v4
      
      # 安裝 ARM Cross Compiler (跟我們 Docker 裡的一樣)
      - name: Install Toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential gcc-arm-none-eabi libnewlib-arm-none-eabi libstdc++-arm-none-eabi-newlib

      # 下載 Pico SDK
      - name: Setup Pico SDK
        run: |
          git clone https://github.com/raspberrypi/pico-sdk.git
          cd pico-sdk
          git submodule update --init
          echo "PICO_SDK_PATH=$PWD" >> $GITHUB_ENV

      # 設定 CMake (指定板子為 pico2_w)
      - name: Configure CMake (Firmware)
        run: cmake -S . -B build -DPICO_BOARD=pico2_w

      # 開始編譯 (使用 4 核心加速)
      - name: Build Firmware
        run: cmake --build build -j4